<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Route - India</title>

    <link rel="stylesheet" href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.css">
    <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.js"></script>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <style>
        #myMap{
            width:100%;
            height:100vh;
        }

        #punchForm{
            position:absolute;
            top:70px;
            right:20px;
            width:270px;
            background:white;
            padding:15px;
            border-radius:8px;
            box-shadow:0 0 12px rgba(0,0,0,0.2);
            z-index:999;
        }

        .punch-success{ color:green; font-size:13px; margin-top:8px;}
        .punch-error{ color:red; font-size:13px; margin-top:8px;}
    </style>
</head>

<body onload="GetMap()">

<div id="myMap"></div>

<div id="punchForm">
    <h5>WFH Location Punch-In</h5>

    <input class="form-control mb-2" type="text" id="empId" placeholder="Employee ID">

    <!-- NEW PASSWORD FIELD -->
    <input class="form-control mb-2" type="password" id="empPass" placeholder="Password (Abc@123)">

    <button class="btn btn-primary btn-block" onclick="punchInEmployee()">Punch In</button>

    <div id="punchResult"></div>
</div>

<script>
function GetMap(){
    navigator.geolocation.getCurrentPosition(showUserLocation, displayEntireMap);
}

function showUserLocation(position){
    var lat = position.coords.latitude;
    var lon = position.coords.longitude;

    map = new atlas.Map("myMap",{
        center:[lon,lat],
        zoom:12,
        authOptions:{
            authType:"subscriptionKey",
            subscriptionKey:""
        }
    });

    map.events.add("ready",function(){
        var marker = new atlas.HtmlMarker({
            position:[lon,lat],
            text:"You"
        });
        map.markers.add(marker);
    });
}

function displayEntireMap(){
    map = new atlas.Map("myMap",{
        center:[78.9629,20.5937],
        zoom:4,
        authOptions:{
            authType:"subscriptionKey",
            subscriptionKey:""
        }
    });
}
</script>

<script>
async function getAddressFromCoordinates(lat,lon){

    const key="29tQsOgaggLiWIY5lVfJ9pQ4MabgWEyAIcJSNCrUfEP1f33W6NDjJQQJ99AGACYeBjFd4FboAAAgAZMPZYdR";

    const url=`https://atlas.microsoft.com/search/address/reverse/json?api-version=1.0&query=${lat},${lon}&subscription-key=${key}`;

    const res=await fetch(url);
    const data=await res.json();

    if(!data.addresses || data.addresses.length===0) return null;

    const a=data.addresses[0].address;

    return{
        fullAddress:a.freeformAddress || "",
        street:a.streetName || "",
        area:a.municipalitySubdivision || "",
        city:a.municipality || "",
        state:a.countrySubdivision || "",
        country:a.country || ""
    };
}
</script>

<script>
async function punchInEmployee(){

    const empId=document.getElementById("empId").value.trim();
    const empPass=document.getElementById("empPass").value.trim();
    const result=document.getElementById("punchResult");

    const idPattern=/^EMP-\d{4}$/;

    // password must exactly match Abc@123 pattern style
    const passPattern=/^[A-Z][a-z]{2}@[0-9]{3}$/;

    if(!idPattern.test(empId)){
        result.innerHTML="<div class='punch-error'>‚ùå Use Employee ID format EMP-1234</div>";
        return;
    }

    if(!passPattern.test(empPass)){
        result.innerHTML="<div class='punch-error'>‚ùå Password must be like Abc@123</div>";
        return;
    }

    navigator.geolocation.getCurrentPosition(async position => {

        const lat=position.coords.latitude;
        const lon=position.coords.longitude;

        const addr=await getAddressFromCoordinates(lat,lon);

        if(!addr){
            result.innerHTML="<div class='punch-error'>‚ùå Could not get address</div>";
            return;
        }

        // success message
        result.innerHTML=`
            <div class="punch-success">
                ‚úÖ Punch Successful<br>
                üë§ ${empId}<br>
                üîê Password OK<br>
                üìç ${addr.fullAddress}
            </div>
        `;

        // send to backend
        await fetch("http://localhost:8000/api/punch",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({
                employeeId:empId,
                password:empPass,
                address:addr.fullAddress,
                street:addr.street,
                area:addr.area,
                city:addr.city,
                state:addr.state,
                country:addr.country,
                latitude:lat,
                longitude:lon,
                status:"PUNCHED_IN"
            })
        });

    },()=>{
        result.innerHTML="<div class='punch-error'>‚ùå Location permission denied</div>";
    });
}
</script>

</body>
</html>