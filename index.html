<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live Employee Location</title>

<!-- Azure Maps CSS & JS -->
<link rel="stylesheet" href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.css">
<script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.js"></script>

<style>
body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: Arial; }
#myMap { width: 100%; height: 100%; }
#punchForm {
  position: absolute;
  top: 20px; left: 20px;
  width: 300px; background: #fff; padding: 15px; border-radius: 8px;
  box-shadow: 0 0 10px rgba(0,0,0,0.2); z-index: 10;
}
#punchForm input, #punchForm button { width: 100%; padding: 8px; margin: 8px 0; }
#punchResult { font-size: 14px; margin-top: 5px; color: green; }
</style>
</head>
<body>

<div id="myMap"></div>

<div id="punchForm">
  <h3>Employee Punch-In</h3>
  <input type="text" id="empId" placeholder="Employee ID (EMP-1234)">
  <input type="password" id="password" placeholder="Password">
  <button onclick="punchInEmployee()">Punch In</button>
  <div id="punchResult"></div>
</div>

<script>
let map, marker, punchInterval;
const subscriptionKey = '29tQsOgaggLiWIY5lVfJ9pQ4MabgWEyAIcJSNCrUfEP1f33W6NDjJQQJ99AGACYeBjFd4FboAAAgAZMPZYdR'; // <-- Replace with your key

function initializeMap(lat=20.5937, lon=78.9629) { // default to India
    map = new atlas.Map('myMap', {
        center: [lon, lat],
        zoom: 5,
        authOptions: { authType: 'subscriptionKey', subscriptionKey: subscriptionKey }
    });

    map.events.add('ready', function () {
        // Add zoom control
        map.controls.add(new atlas.control.ZoomControl(), { position: 'top-right' });
    });
}

async function punchInEmployee() {
    const empId = document.getElementById("empId").value.trim();
    const password = document.getElementById("password").value.trim();
    const result = document.getElementById("punchResult");

    // Validate
    if (!/^EMP-\d{4}$/.test(empId)) { result.innerHTML="Invalid Employee ID"; return; }
    if (password.length < 6) { result.innerHTML="Password too short"; return; }

    if (punchInterval) clearInterval(punchInterval); // Stop previous interval

    async function sendLocation() {
        if (!navigator.geolocation) { result.innerHTML="Geolocation not supported"; return; }

        navigator.geolocation.getCurrentPosition(async (pos) => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;

            // Update map
            if (!map) initializeMap(lat, lon);
            if (!marker) {
                marker = new atlas.HtmlMarker({
                    color: 'blue',
                    position: [lon, lat],
                    text: "You"
                });
                map.markers.add(marker);
                map.setCamera({ center: [lon, lat], zoom: 12 });
            } else {
                marker.setOptions({ position: [lon, lat] });
                map.setCamera({ center: [lon, lat] });
            }

            // Send to backend
            const payload = {
                employeeId: empId,
                password: password,
                latitude: lat,
                longitude: lon,
                address: `Lat: ${lat.toFixed(4)}, Lon: ${lon.toFixed(4)}`,
                status: "PUNCHED_IN"
            };

            try {
                const res = await fetch("http://localhost:3000/api/punch-in", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();
                if (res.ok) {
                    result.innerHTML = `âœ” Punched in at ${new Date().toLocaleTimeString()}<br>
                                        Lat: ${lat.toFixed(4)}, Lon: ${lon.toFixed(4)}`;
                } else {
                    result.innerHTML = ` ${data.message}`;
                }
            } catch (err) {
                console.error(err);
                result.innerHTML = " Error connecting to server";
            }

        }, () => { result.innerHTML=" Location permission denied"; });
    }

    sendLocation();
    punchInterval = setInterval(sendLocation, 8000); // Update every 8 seconds
}

</script>

</body>
</html>

